{% extends "base.html" %}

// Collect panel rows into an object: { channel_id: message_id or '' }
function collectPanels() {
    const container = document.getElementById('panels_container');
    const result = {};
    if (!container) return result;
    const rows = container.querySelectorAll('.panel-row');
    rows.forEach(row => {
        const chSel = row.querySelector('.panel-channel');
        const msgInp = row.querySelector('.panel-message');
        const chId = chSel && chSel.value ? chSel.value : '';
        const msgId = msgInp && msgInp.value ? msgInp.value.trim() : '';
        if (chId) {
            result[chId] = msgId || '';
        }
    });
    return result;
}

// Collect ignored channels into an array
function collectIgnoredChannels() {
    const container = document.getElementById('ignored_channels');
    const values = [];
    if (!container) return values;
    const rows = container.querySelectorAll('.ignored-row');
    rows.forEach(row => {
        const sel = row.querySelector('.ignored-channel');
        const val = sel && sel.value ? sel.value : '';
        if (val) values.push(val);
    });
    return values;
}

{% block content %}
<div class="configure-header">
    <div class="container">
        <div class="server-header">
            <div class="server-icon">
                {% if guild.icon %}
                <img src="https://cdn.discordapp.com/icons/{{ guild.id }}/{{ guild.icon }}.png?size=64" alt="{{ guild.name }}">
                {% else %}
                <div class="server-icon-placeholder">
                    <i class="fas fa-server"></i>
                </div>
                {% endif %}
            </div>
            <div class="server-details">
                <h1 class="server-name">{{ guild.name }}</h1>
                <p class="server-id">Configuring server: {{ guild.id }}</p>
            </div>
        </div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
        </a>
    </div>
</div>

<div class="configure-content">
    <div class="container">
        <form id="configForm" class="config-form">
            <div class="config-sections">
                <!-- Role Configuration -->
                <div class="config-section">
                    <h3 class="section-title">
                        <i class="fas fa-users"></i>
                        Role Configuration
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="support_role_id">Support Role</label>
                            <select id="support_role_id" name="support_role_id">
                                <option value="">Select a role...</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}" {% if config.support_role_id == role.id %}selected{% endif %}>{{ role.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="moderator_role_id">Moderator Role</label>
                            <select id="moderator_role_id" name="moderator_role_id">
                                <option value="">Select a role...</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}" {% if config.moderator_role_id == role.id %}selected{% endif %}>{{ role.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="administrator_role_id">Administrator Role</label>
                            <select id="administrator_role_id" name="administrator_role_id">
                                <option value="">Select a role...</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}" {% if config.administrator_role_id == role.id|string %}selected{% endif %}>
                                    {{ role.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="suspended_role_id">Suspended Role</label>
                            <select id="suspended_role_id" name="suspended_role_id" class="role-select">
                                <option value="">Select a role...</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}" {% if config.suspended_role_id == role.id|string %}selected{% endif %}>
                                    {{ role.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="verified_role_id">Verified Role</label>
                            <select id="verified_role_id" name="verified_role_id" class="role-select">
                                <option value="">Select a role...</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}" {% if config.verified_role_id == role.id|string %}selected{% endif %}>
                                    {{ role.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="nitro_role_id">Nitro Role</label>
                            <select id="nitro_role_id" name="nitro_role_id" class="role-select">
                                <option value="">Select a role...</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}" {% if config.nitro_role_id == role.id|string %}selected{% endif %}>
                                    {{ role.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Channel Configuration -->
                <div class="config-section">
                    <h3 class="section-title">
                        <i class="fas fa-hashtag"></i>
                        Channel Configuration
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="moderation_logs">Moderation Logs</label>
                            <select id="moderation_logs" name="moderation_logs" class="channel-select">
                                <option value="">Select a channel...</option>
                                {% for channel in channels %}
                                {% if channel.type == 0 %}
                                <option value="{{ channel.id }}" {% if config.moderation_logs == channel.id|string %}selected{% endif %}>
                                    # {{ channel.name }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tickets_log_channel_id">Tickets Log Channel</label>
                            <select id="tickets_log_channel_id" name="tickets_log_channel_id" class="channel-select">
                                <option value="">Select a channel...</option>
                                {% for channel in channels %}
                                {% if channel.type == 0 %}
                                <option value="{{ channel.id }}" {% if config.tickets_log_channel_id == channel.id|string %}selected{% endif %}>
                                    # {{ channel.name }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transfer_log_channel_id">Transfer Log Channel</label>
                            <select id="transfer_log_channel_id" name="transfer_log_channel_id" class="channel-select">
                                <option value="">Select a channel...</option>
                                {% for channel in channels %}
                                {% if channel.type == 0 %}
                                <option value="{{ channel.id }}" {% if config.transfer_log_channel_id == channel.id|string %}selected{% endif %}>
                                    # {{ channel.name }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="update_logs_channel_id">Update Logs Channel</label>
                            <select id="update_logs_channel_id" name="update_logs_channel_id" class="channel-select">
                                <option value="">Select a channel...</option>
                                {% for channel in channels %}
                                {% if channel.type == 0 %}
                                <option value="{{ channel.id }}" {% if config.update_logs_channel_id == channel.id|string %}selected{% endif %}>
                                    # {{ channel.name }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="BOT_LOGS_CHANNEL_ID">Bot Logs Channel</label>
                            <select id="BOT_LOGS_CHANNEL_ID" name="BOT_LOGS_CHANNEL_ID" class="channel-select">
                                <option value="">Select a channel...</option>
                                {% for channel in channels %}
                                {% if channel.type == 0 %}
                                <option value="{{ channel.id }}" {% if config.BOT_LOGS_CHANNEL_ID == channel.id|string %}selected{% endif %}>
                                    # {{ channel.name }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="AutoMuteLogs">Auto Mute Logs Channel</label>
                            <select id="AutoMuteLogs" name="AutoMuteLogs" class="channel-select">
                                <option value="">Select a channel...</option>
                                {% for channel in channels %}
                                {% if channel.type == 0 %}
                                <option value="{{ channel.id }}" {% if config.AutoMuteLogs == channel.id|string %}selected{% endif %}>
                                    # {{ channel.name }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="GIVEAWAYS_CHANNEL_ID">Giveaways Channel</label>
                            <select id="GIVEAWAYS_CHANNEL_ID" name="GIVEAWAYS_CHANNEL_ID" class="channel-select">
                                <option value="">Select a channel...</option>
                                {% for channel in channels %}
                                {% if channel.type == 0 %}
                                <option value="{{ channel.id }}" {% if config.GIVEAWAYS_CHANNEL_ID == channel.id|string %}selected{% endif %}>
                                    # {{ channel.name }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tickets_category_id">Tickets Category</label>
                            <select id="tickets_category_id" name="tickets_category_id" class="channel-select">
                                <option value="">Select a category...</option>
                                {% for channel in channels %}
                                {% if channel.type == 4 %}
                                <option value="{{ channel.id }}" {% if config.tickets_category_id == channel.id|string %}selected{% endif %}>
                                    üìÅ {{ channel.name }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="unfairMuteCategoryID">Unfair Mute Category</label>
                            <select id="unfairMuteCategoryID" name="unfairMuteCategoryID" class="channel-select">
                                <option value="">Select a category...</option>
                                {% for channel in channels %}
                                {% if channel.type == 4 %}
                                <option value="{{ channel.id }}" {% if config.unfairMuteCategoryID == channel.id|string %}selected{% endif %}>
                                    üìÅ {{ channel.name }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="watchlistRoleID">Watchlist Role</label>
                            <select id="watchlistRoleID" name="watchlistRoleID" class="role-select">
                                <option value="">Select a role...</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}" {% if config.watchlistRoleID == role.id|string %}selected{% endif %}>
                                    {{ role.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="developer_role_id_diff">Developer Role</label>
                            <select id="developer_role_id_diff" name="developer_role_id_diff" class="role-select">
                                <option value="">Select a role...</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}" {% if config.developer_role_id_diff == role.id|string %}selected{% endif %}>
                                    {{ role.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sib_role_id_diff">SIB Role</label>
                            <select id="sib_role_id_diff" name="sib_role_id_diff" class="role-select">
                                <option value="">Select a role...</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}" {% if config.sib_role_id_diff == role.id|string %}selected{% endif %}>
                                    {{ role.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cos_role_id_diff">COS Role</label>
                            <select id="cos_role_id_diff" name="cos_role_id_diff" class="role-select">
                                <option value="">Select a role...</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}" {% if config.cos_role_id_diff == role.id|string %}selected{% endif %}>
                                    {{ role.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="verification_category_id">Verification Category</label>
                            <select id="verification_category_id" name="verification_category_id" class="channel-select">
                                <option value="">Select a category...</option>
                                {% for channel in channels %}
                                {% if channel.type == 4 %}
                                <option value="{{ channel.id }}" {% if config.verification_category_id == channel.id|string %}selected{% endif %}>
                                    üìÅ {{ channel.name }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="MANAGEMENT_LOGS_ID">Management Logs Channel</label>
                            <select id="MANAGEMENT_LOGS_ID" name="MANAGEMENT_LOGS_ID" class="channel-select">
                                <option value="">Select a channel...</option>
                                {% for channel in channels %}
                                {% if channel.type == 0 %}
                                <option value="{{ channel.id }}" {% if config.MANAGEMENT_LOGS_ID == channel.id|string %}selected{% endif %}># {{ channel.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="EXILE_LOGS_ID">Exile Logs Channel</label>
                            <select id="EXILE_LOGS_ID" name="EXILE_LOGS_ID" class="channel-select">
                                <option value="">Select a channel...</option>
                                {% for channel in channels %}
                                {% if channel.type == 0 %}
                                <option value="{{ channel.id }}" {% if config.EXILE_LOGS_ID == channel.id|string %}selected{% endif %}># {{ channel.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="BMT_LOGS_CHANNEL_ID">BMT Logs Channel</label>
                            <select id="BMT_LOGS_CHANNEL_ID" name="BMT_LOGS_CHANNEL_ID" class="channel-select">
                                <option value="">Select a channel...</option>
                                {% for channel in channels %}
                                {% if channel.type == 0 %}
                                <option value="{{ channel.id }}" {% if config.BMT_LOGS_CHANNEL_ID == channel.id|string %}selected{% endif %}># {{ channel.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="EVENT_POSTS_CHANNEL_ID">Event Posts Channel</label>
                            <select id="EVENT_POSTS_CHANNEL_ID" name="EVENT_POSTS_CHANNEL_ID" class="channel-select">
                                <option value="">Select a channel...</option>
                                {% for channel in channels %}
                                {% if channel.type == 0 %}
                                <option value="{{ channel.id }}" {% if config.EVENT_POSTS_CHANNEL_ID == channel.id|string %}selected{% endif %}># {{ channel.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="TRYOUT_CATEGORY_ID">Tryout Category</label>
                            <select id="TRYOUT_CATEGORY_ID" name="TRYOUT_CATEGORY_ID" class="channel-select">
                                <option value="">Select a category...</option>
                                {% for channel in channels %}
                                {% if channel.type == 4 %}
                                <option value="{{ channel.id }}" {% if config.TRYOUT_CATEGORY_ID == channel.id|string %}selected{% endif %}>üìÅ {{ channel.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- API Tokens -->
                <div class="config-section">
                    <h3 class="section-title">
                        <i class="fas fa-key"></i>
                        API Tokens
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="ROWIFI_API_TOKEN">RoWifi API Token</label>
                            <input type="text" id="ROWIFI_API_TOKEN" name="ROWIFI_API_TOKEN" value="{{ config.ROWIFI_API_TOKEN or '' }}" placeholder="Enter RoWifi API token">
                        </div>
                        <div class="form-group">
                            <label for="TRELLO_API_KEY">Trello API Key</label>
                            <input type="text" id="TRELLO_API_KEY" name="TRELLO_API_KEY" value="{{ config.TRELLO_API_KEY or '' }}" placeholder="Enter Trello API key">
                        </div>
                        <div class="form-group">
                            <label for="TRELLO_API_TOKEN">Trello API Token</label>
                            <input type="text" id="TRELLO_API_TOKEN" name="TRELLO_API_TOKEN" value="{{ config.TRELLO_API_TOKEN or '' }}" placeholder="Enter Trello API token">
                        </div>
                        <div class="form-group">
                            <label for="SSU_GAME_LINK">SSU Game Link</label>
                            <input type="url" id="SSU_GAME_LINK" name="SSU_GAME_LINK" value="{{ config.SSU_GAME_LINK or '' }}" placeholder="https://www.roblox.com/games/...">
                        </div>
                    </div>
                </div>

                <!-- Custom Lists -->
                <div class="config-section">
                    <h3 class="section-title">
                        <i class="fas fa-list"></i>
                        Custom Configuration
                    </h3>
                    
                    <!-- Blacklisted Groups -->
                    <div class="list-config">
                        <label>Blacklisted Groups</label>
                        <div id="blacklisted_groups">
                            <div class="list-container">
                                {% for group in config.blacklisted_groups or [] %}
                                <div class="list-item">
                                    <input type="number" value="{{ group }}" placeholder="Group ID">
                                    <button type="button" class="remove-item">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="add-item" onclick="addListItem('blacklisted_groups', 'number')">
                                <i class="fas fa-plus"></i>
                                Add Group ID
                            </button>
                        </div>
                    </div>

                    <!-- Whitelisted Groups -->
                    <div class="list-config">
                        <label>Whitelisted Groups</label>
                        <div id="whitelisted_groups">
                            <div class="list-container">
                                {% for group in config.whitelisted_groups or [] %}
                                <div class="list-item">
                                    <input type="number" value="{{ group }}" placeholder="Group ID">
                                    <button type="button" class="remove-item">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="add-item" onclick="addListItem('whitelisted_groups', 'number')">
                                <i class="fas fa-plus"></i>
                                Add Group ID
                            </button>
                        </div>
                    </div>

                    <!-- Blacklisted Names -->
                    <div class="list-config">
                        <label>Blacklisted Names</label>
                        <div id="blacklisted_names">
                            <div class="list-container">
                                {% for name in config.blacklisted_names or [] %}
                                <div class="list-item">
                                    <input type="text" value="{{ name }}" placeholder="Name">
                                    <button type="button" class="remove-item">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="add-item" onclick="addListItem('blacklisted_names', 'text')">
                                <i class="fas fa-plus"></i>
                                Add Name
                            </button>
                        </div>
                    </div>

                    <!-- Groups to Check -->
                    <div class="list-config">
                        <label>Groups to Check</label>
                        <div id="groups_to_check">
                            <div class="list-container">
                                {% for group in config.groups_to_check or [] %}
                                <div class="list-item">
                                    <input type="number" value="{{ group }}" placeholder="Group ID">
                                    <button type="button" class="remove-item">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="add-item" onclick="addListItem('groups_to_check', 'number')">
                                <i class="fas fa-plus"></i>
                                Add Group ID
                            </button>
                        </div>
                    </div>

                    <!-- Group & BMT Settings -->
                    <div class="form-grid" style="margin-top: 20px;">
                        <div class="form-group">
                            <label for="main_group_id">Main Group ID</label>
                            <input type="number" id="main_group_id" name="main_group_id" value="{{ config.main_group_id or '' }}" placeholder="Enter main group ID">
                        </div>
                        <div class="form-group">
                            <label for="BMT_GROUP_ID">BMT Group ID</label>
                            <input type="number" id="BMT_GROUP_ID" name="BMT_GROUP_ID" value="{{ config.BMT_GROUP_ID or '' }}" placeholder="Enter BMT group ID">
                        </div>
                        <div class="form-group">
                            <label for="BMT_RANK_ID">BMT Rank ID</label>
                            <input type="number" id="BMT_RANK_ID" name="BMT_RANK_ID" value="{{ config.BMT_RANK_ID or '' }}" placeholder="Enter BMT rank ID">
                        </div>
                        <div class="form-group">
                            <label for="BMT_REQUIRED_RANK">BMT Required Rank</label>
                            <input type="number" id="BMT_REQUIRED_RANK" name="BMT_REQUIRED_RANK" value="{{ config.BMT_REQUIRED_RANK or '' }}" placeholder="Enter BMT required rank">
                        </div>
                        <div class="form-group">
                            <label for="ETS_GROUP_ID">ETS Group ID</label>
                            <input type="number" id="ETS_GROUP_ID" name="ETS_GROUP_ID" value="{{ config.ETS_GROUP_ID or '' }}" placeholder="Enter ETS group ID">
                        </div>
                        <div class="form-group">
                            <label for="ETS_MIN_RANK_ID">ETS Min Rank ID</label>
                            <input type="number" id="ETS_MIN_RANK_ID" name="ETS_MIN_RANK_ID" value="{{ config.ETS_MIN_RANK_ID or '' }}" placeholder="Enter ETS minimum rank ID">
                        </div>
                    </div>

                    <!-- Color Roles -->
                    <div class="list-config">
                        <label>Color Roles</label>
                        <div id="colour_roles">
                            <div class="list-container">
                                {% for role in config.colour_roles or [] %}
                                <div class="list-item">
                                    <input type="text" value="{{ role }}" placeholder="Role Name">
                                    <button type="button" class="remove-item">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="add-item" onclick="addListItem('colour_roles', 'text')">
                                <i class="fas fa-plus"></i>
                                Add Role
                            </button>
                        </div>
                    </div>

                    <!-- Timezone Roles -->
                    <div class="list-config">
                        <label>Timezone Roles</label>
                        <div id="timezone_roles">
                            <div class="list-container">
                                {% for role in config.timezone_roles or [] %}
                                <div class="list-item">
                                    <input type="text" value="{{ role }}" placeholder="Timezone">
                                    <button type="button" class="remove-item">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="add-item" onclick="addListItem('timezone_roles', 'text')">
                                <i class="fas fa-plus"></i>
                                Add Timezone
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paneling Configuration -->
            <div class="config-section">
                <h3 class="section-title">
                    <i class="fas fa-sliders-h"></i>
                    Paneling
                </h3>

                <div class="form-grid">
                    <!-- Mass Ticket Closing Panel (channel -> message) -->
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Mass Ticket Closing Panel(s)</label>
                        <div id="panels_container" class="list-config">
                            <div class="list-container">
                                {% if config.PANELS %}
                                    {% for chan_id, msg_id in config.PANELS.items() %}
                                    <div class="list-item panel-row">
                                        <select class="panel-channel">
                                            <option value="">Select a channel...</option>
                                            {% for channel in channels %}
                                            {% if channel.type == 0 %}
                                            <option value="{{ channel.id }}" {% if chan_id == channel.id|string %}selected{% endif %}># {{ channel.name }}</option>
                                            {% endif %}
                                            {% endfor %}
                                        </select>
                                        <input type="text" class="panel-message" placeholder="Message ID (optional)" value="{{ msg_id or '' }}">
                                        <button type="button" class="remove-item"><i class="fas fa-times"></i></button>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <button type="button" class="add-item" id="add_panel_row"><i class="fas fa-plus"></i> Add Panel</button>
                        </div>
                        <small>ChannelID : MessageID (MessageID optional; leave blank to create a new message later)</small>
                    </div>

                    <!-- Mass closure logs channel -->
                    <div class="form-group">
                        <label for="MASS_CLOSURE_LOG_CHANNEL_ID">Mass Closure Log Channel</label>
                        <select id="MASS_CLOSURE_LOG_CHANNEL_ID" name="MASS_CLOSURE_LOG_CHANNEL_ID" class="channel-select">
                            <option value="">Select a channel...</option>
                            {% for channel in channels %}
                            {% if channel.type == 0 %}
                            <option value="{{ channel.id }}" {% if config.MASS_CLOSURE_LOG_CHANNEL_ID == channel.id|string %}selected{% endif %}># {{ channel.name }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Ticket Category -->
                    <div class="form-group">
                        <label for="TICKET_CATEGORY_ID">Ticket Category</label>
                        <select id="TICKET_CATEGORY_ID" name="TICKET_CATEGORY_ID" class="channel-select">
                            <option value="">Select a category...</option>
                            {% for channel in channels %}
                            {% if channel.type == 4 %}
                            <option value="{{ channel.id }}" {% if config.TICKET_CATEGORY_ID == channel.id|string %}selected{% endif %}>üìÅ {{ channel.name }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Ignored channels -->
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Ignored Channels</label>
                        <div id="ignored_channels" class="list-config">
                            <div class="list-container">
                                {% for ch_id in config.IGNORED_CHANNEL_IDS or [] %}
                                <div class="list-item ignored-row">
                                    <select class="ignored-channel">
                                        <option value="">Select a channel...</option>
                                        {% for channel in channels %}
                                        {% if channel.type == 0 %}
                                        <option value="{{ channel.id }}" {% if ch_id == channel.id|string %}selected{% endif %}># {{ channel.name }}</option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="remove-item"><i class="fas fa-times"></i></button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="add-item" id="add_ignored_channel"><i class="fas fa-plus"></i> Add Ignored Channel</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save Configuration
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <i class="fas fa-undo"></i>
                    Reset
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Add new list item function
function addListItem(containerId, inputType) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Container with ID '${containerId}' not found`);
        return;
    }
    
    const listContainer = container.querySelector('.list-container');
    if (!listContainer) {
        console.error(`List container not found in '${containerId}'`);
        return;
    }
    
    const listItem = document.createElement('div');
    listItem.className = 'list-item';
    
    const input = document.createElement('input');
    input.type = inputType;
    input.placeholder = inputType === 'number' ? 'Enter ID' : 'Enter value';
    
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'remove-item';
    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
    removeBtn.addEventListener('click', function() {
        listItem.remove();
    });
    
    listItem.appendChild(input);
    listItem.appendChild(removeBtn);
    listContainer.appendChild(listItem);
    
    // Focus the new input
    input.focus();
}

// Helpers to collect list values
function collectListValues(containerId, type) {
    const container = document.getElementById(containerId);
    const values = [];
    if (!container) return values;
    const inputs = container.querySelectorAll('.list-container input');
    inputs.forEach(input => {
        const val = input.value.trim();
        if (val !== '') {
            if (type === 'number') {
                const num = Number(val);
                if (!Number.isNaN(num)) values.push(num);
            } else {
                values.push(val);
            }
        }
    });
    return values;
}

// Collect panel rows into an object: { channel_id: message_id or '' }
function collectPanels() {
    const container = document.getElementById('panels_container');
    const result = {};
    if (!container) return result;
    const rows = container.querySelectorAll('.panel-row');
    rows.forEach(row => {
        const chSel = row.querySelector('.panel-channel');
        const msgInp = row.querySelector('.panel-message');
        const chId = chSel && chSel.value ? chSel.value : '';
        const msgId = msgInp && msgInp.value ? msgInp.value.trim() : '';
        if (chId) {
            result[chId] = msgId || '';
        }
    });
    return result;
}

// Collect ignored channels into an array
function collectIgnoredChannels() {
    const container = document.getElementById('ignored_channels');
    const values = [];
    if (!container) return values;
    const rows = container.querySelectorAll('.ignored-row');
    rows.forEach(row => {
        const sel = row.querySelector('.ignored-channel');
        const val = sel && sel.value ? sel.value : '';
        if (val) values.push(val);
    });
    return values;
}

// Form submission handler
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, looking for form...');
    const form = document.getElementById('configForm');
    if (!form) {
        console.error('Form with ID configForm not found!');
        return;
    }
    console.log('Form found:', form);
    
    // Pre-build channel options for dynamic elements
    const channelOptions = `
        {% for channel in channels %}{% if channel.type == 0 %}
        <option value="{{ channel.id }}"># {{ channel.name }}</option>
        {% endif %}{% endfor %}
    `;

    // Wire add/remove for dynamic Panel rows
    const panelsContainer = document.getElementById('panels_container');
    const addPanelBtn = document.getElementById('add_panel_row');
    if (addPanelBtn && panelsContainer) {
        addPanelBtn.addEventListener('click', function() {
            const row = document.createElement('div');
            row.className = 'list-item panel-row';
            row.innerHTML = `
                <select class="panel-channel">
                    <option value="">Select a channel...</option>
                    ${channelOptions}
                </select>
                <input type="text" class="panel-message" placeholder="Message ID (optional)">
                <button type="button" class="remove-item"><i class="fas fa-times"></i></button>
            `;
            panelsContainer.querySelector('.list-container').appendChild(row);
        });
        panelsContainer.addEventListener('click', function(e) {
            if (e.target.closest('.remove-item')) {
                const row = e.target.closest('.list-item');
                if (row) row.remove();
            }
        });
    }

    // Wire add/remove for Ignored Channels rows
    const ignoredContainer = document.getElementById('ignored_channels');
    const addIgnoredBtn = document.getElementById('add_ignored_channel');
    if (addIgnoredBtn && ignoredContainer) {
        addIgnoredBtn.addEventListener('click', function() {
            const row = document.createElement('div');
            row.className = 'list-item ignored-row';
            row.innerHTML = `
                <select class="ignored-channel">
                    <option value="">Select a channel...</option>
                    ${channelOptions}
                </select>
                <button type="button" class="remove-item"><i class="fas fa-times"></i></button>
            `;
            ignoredContainer.querySelector('.list-container').appendChild(row);
        });
        ignoredContainer.addEventListener('click', function(e) {
            if (e.target.closest('.remove-item')) {
                const row = e.target.closest('.list-item');
                if (row) row.remove();
            }
        });
    }
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Form submitted! Preparing payload...');

        // Gather role/channel select values
        const getVal = (id) => {
            const el = document.getElementById(id);
            return el && el.value ? el.value : '';
        };

        const payload = {
            // Roles
            support_role_id: getVal('support_role_id'),
            moderator_role_id: getVal('moderator_role_id'),
            administrator_role_id: getVal('administrator_role_id'),
            suspended_role_id: getVal('suspended_role_id'),
            verified_role_id: getVal('verified_role_id'),
            nitro_role_id: getVal('nitro_role_id'),

            // Channels
            moderation_logs: getVal('moderation_logs'),
            tickets_log_channel_id: getVal('tickets_log_channel_id'),
            transfer_log_channel_id: getVal('transfer_log_channel_id'),
            update_logs_channel_id: getVal('update_logs_channel_id'),
            BOT_LOGS_CHANNEL_ID: getVal('BOT_LOGS_CHANNEL_ID'),
            AutoMuteLogs: getVal('AutoMuteLogs'),
            GIVEAWAYS_CHANNEL_ID: getVal('GIVEAWAYS_CHANNEL_ID'),
            tickets_category_id: getVal('tickets_category_id'),
            verification_category_id: getVal('verification_category_id'),
            MANAGEMENT_LOGS_ID: getVal('MANAGEMENT_LOGS_ID'),
            EXILE_LOGS_ID: getVal('EXILE_LOGS_ID'),
            BMT_LOGS_CHANNEL_ID: getVal('BMT_LOGS_CHANNEL_ID'),
            EVENT_POSTS_CHANNEL_ID: getVal('EVENT_POSTS_CHANNEL_ID'),
            TRYOUT_CATEGORY_ID: getVal('TRYOUT_CATEGORY_ID'),

            // Tokens and misc
            ROWIFI_API_TOKEN: getVal('ROWIFI_API_TOKEN'),
            TRELLO_API_KEY: getVal('TRELLO_API_KEY'),
            TRELLO_API_TOKEN: getVal('TRELLO_API_TOKEN'),
            SSU_GAME_LINK: getVal('SSU_GAME_LINK'),
            main_group_id: getVal('main_group_id'),
            BMT_GROUP_ID: getVal('BMT_GROUP_ID'),
            BMT_RANK_ID: getVal('BMT_RANK_ID'),
            BMT_REQUIRED_RANK: getVal('BMT_REQUIRED_RANK'),
            ETS_GROUP_ID: getVal('ETS_GROUP_ID'),
            ETS_MIN_RANK_ID: getVal('ETS_MIN_RANK_ID'),

            // Lists
            blacklisted_groups: collectListValues('blacklisted_groups', 'number'),
            whitelisted_groups: collectListValues('whitelisted_groups', 'number'),
            blacklisted_names: collectListValues('blacklisted_names', 'text'),
            groups_to_check: collectListValues('groups_to_check', 'number'),
            colour_roles: collectListValues('colour_roles', 'text'),
            timezone_roles: collectListValues('timezone_roles', 'text')
            ,
            // Paneling
            PANELS: collectPanels(),
            MASS_CLOSURE_LOG_CHANNEL_ID: getVal('MASS_CLOSURE_LOG_CHANNEL_ID'),
            TICKET_CATEGORY_ID: getVal('TICKET_CATEGORY_ID'),
            IGNORED_CHANNEL_IDS: collectIgnoredChannels(),
            
            // Additional fields
            unfairMuteCategoryID: getVal('unfairMuteCategoryID'),
            watchlistRoleID: getVal('watchlistRoleID'),
            developer_role_id_diff: getVal('developer_role_id_diff'),
            sib_role_id_diff: getVal('sib_role_id_diff'),
            cos_role_id_diff: getVal('cos_role_id_diff')
        };

        try {
            console.log('Saving configuration payload:', payload);
            const res = await fetch(`/save_config/{{ guild.id }}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            console.log('Response status:', res.status);
            const data = await res.json();
            console.log('Response data:', data);
            if (data && data.success) {
                alert('Configuration saved successfully!');
                // Optionally refresh to load persisted values
                location.reload();
            } else {
                alert('Failed to save configuration: ' + (data && data.message ? data.message : 'Unknown error'));
            }
        } catch (err) {
            console.error('Save failed', err);
            alert('Failed to save configuration. Please try again.');
        }
    });
});
</script>
{% endblock %}
